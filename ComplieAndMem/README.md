

- [Complie And Memeory 编译及内存相关](#complie-and-memeory-编译及内存相关)
- [寄存器](#寄存器)
  - [常见寄存器的分类](#常见寄存器的分类)
- [引用](#引用)

# Complie And Memeory 编译及内存相关

# 寄存器
## 常见寄存器的分类
1. 通用寄存器（EAX EBX ECX EDX EBP ESP ESI EDI）
   - EAX 累加寄存器
     - 作用：实现乘除运算、中间结果缓存
   - EBX——基址寄存器（Base Register）
     - 作用：存储器指针
   - ECX——计数寄存器（Count Register）
     - 作用：实现循环控制、进行串操作
   - EDX——数据寄存器（Data Register）
     - 作用：实现乘除运算、中间结果缓存（与EAX类似）
   - EBP——基址指针寄存器（Base Pointer Register）
     - 作用：指向栈帧底部或栈底（栈帧底部和栈底是两个不同的概念）
   - ESP——堆栈指针寄存器（Stack Pointer Register）
     - 作用：指向栈帧顶部或栈顶（栈帧顶部和栈顶是两个不同的概念）
2. 段寄存器（CS DS SS ES FS GS）
3. 指令指针寄存器（EIP）
4. 标志寄存器（EFLAGS）

# 引用

问题这个sum的引用指向了哪里？

- left+right的结果存在了哪里
- 引用sum指向了哪里
```C++
int main() {
    int left = 0xff;
    int right = 0xff00;
    const int& sum = left + right;
    return 0;
}
```

使用编译器生成汇编代码
```
cl [filename] /FA
```
从vs上方的 "工具-->命令行-->开发者命令提示"打开命令行。执行
实际命令:
```
D:\srccode\cplusplusdemo\ComplieAndMem\build>cl ..\reference\main.cpp /FA
```
输出为
```
D:\srccode\cplusplusdemo\ComplieAndMem\build>cl ..\reference\main.cpp /FA
用于 x86 的 Microsoft (R) C/C++ 优化编译器 19.29.30148 版
版权所有(C) Microsoft Corporation。保留所有权利。

main.cpp
Microsoft (R) Incremental Linker Version 14.29.30148.0
Copyright (C) Microsoft Corporation.  All rights reserved.

/out:main.exe
main.obj

D:\srccode\cplusplusdemo\ComplieAndMem\build>
```

查看生成的汇编代码文件

main.asm

```asm
; Listing generated by Microsoft (R) Optimizing Compiler Version 19.29.30148.0 

	TITLE	D:\srccode\cplusplusdemo\ComplieAndMem\build\main.obj
	.686P
	.XMM
	include listing.inc
	.model	flat

INCLUDELIB LIBCMT
INCLUDELIB OLDNAMES

PUBLIC	_main
; Function compile flags: /Odtp
_TEXT	SEGMENT
_sum$ = -16						; size = 4
_$S1$ = -12						; size = 4
_right$ = -8						; size = 4
_left$ = -4						; size = 4
_main	PROC
; File D:\srccode\cplusplusdemo\ComplieAndMem\reference\main.cpp
; Line 1
	push	ebp
	mov	ebp, esp
	sub	esp, 16					; 00000010H
; Line 2
	mov	DWORD PTR _left$[ebp], 255		; 000000ffH
; Line 3
	mov	DWORD PTR _right$[ebp], 65280		; 0000ff00H
; Line 4
	mov	eax, DWORD PTR _left$[ebp]
	add	eax, DWORD PTR _right$[ebp]
	mov	DWORD PTR _$S1$[ebp], eax
	lea	ecx, DWORD PTR _$S1$[ebp]
	mov	DWORD PTR _sum$[ebp], ecx
; Line 5
	xor	eax, eax
; Line 6
	mov	esp, ebp
	pop	ebp
	ret	0
_main	ENDP
_TEXT	ENDS
END

```

- 栈申请了16个字节
    - sub sub	esp, 16	
    - 分别存储
      - left
      - right
      - left+right的结果临时变量S1
      - sum
- left + right的结果放在栈里
- sum指向了临时变量S1
  - S1也在栈里，就在sum的前面
  - 

给代码加一下注解
```asm
; Listing generated by Microsoft (R) Optimizing Compiler Version 19.29.30148.0 

	TITLE	D:\srccode\cplusplusdemo\ComplieAndMem\build\main.obj
	.686P
	.XMM
	include listing.inc
	.model	flat

INCLUDELIB LIBCMT
INCLUDELIB OLDNAMES

PUBLIC	_main
; Function compile flags: /Odtp
_TEXT	SEGMENT
_sum$ = -16						; size = 4
_$S1$ = -12						; size = 4
_right$ = -8						; size = 4
_left$ = -4						; size = 4
_main	PROC
; File D:\srccode\cplusplusdemo\ComplieAndMem\reference\main.cpp
; Line 1
	push	ebp
	mov	ebp, esp
	sub	esp, 16					; 00000010H 给栈申请了16个字节空间（栈顶-16、栈由大到小扩展），存储四个变量（如上提示）：left、right、left+right的临时变量、引用sum
; Line 2
	mov	DWORD PTR _left$[ebp], 255		; 000000ffH
; Line 3
	mov	DWORD PTR _right$[ebp], 65280		; 0000ff00H
; Line 4
	mov	eax, DWORD PTR _left$[ebp]
	add	eax, DWORD PTR _right$[ebp]
	mov	DWORD PTR _$S1$[ebp], eax  ;把累加器的值放到S1。即栈在ebp-12的位置
	lea	ecx, DWORD PTR _$S1$[ebp]  ;将S1的值放到计数寄存器ecx
	mov	DWORD PTR _sum$[ebp], ecx  ;将ecx的值放到sum，即栈在ebp -16的位置
; Line 5
	xor	eax, eax
; Line 6
	mov	esp, ebp
	pop	ebp
	ret	0
_main	ENDP
_TEXT	ENDS
END

```

